<!DOCTYPE html>
<html>
<head>
    <title>Datos DHT22</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #4CAF50; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .nuevo { background-color: #ffffcc !important; animation: highlight 2s; }
        @keyframes highlight { from { background-color: #ffff00; } to { background-color: #f2f2f2; } }
    </style>
</head>
<body>
    <h1>Datos del Sensor DHT22</h1>
    <div id="status" style="margin-bottom:10px;padding:8px;border-radius:4px;background:#f8f9fa;color:#333">Conectando al servidor WebSocket...</div>
    <p id="total">Total de registros: {{ datos|length }}</p>

    <table id="tabla-datos">
        <thead>
            <tr>
                <th>ID</th>
                <th>Temperatura (°C)</th>
                <th>Humedad (%)</th>
                <th>Nodo</th>
                <th>Fecha</th>
            </tr>
        </thead>
        <tbody>
            {% for dato in datos %}
            <tr>
                <td>{{ dato.id }}</td>
                <td class="temp">{{ "%.1f"|format(dato.temperatura) }}°C</td>
                <td class="hum">{{ "%.1f"|format(dato.humedad) }}%</td>
                <td>{{ dato.nodeId }}</td>
                <td>{{ dato.fecha_creacion }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5">No hay datos disponibles</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Socket.IO client -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        // Conectarse al servidor Socket.IO (misma origin). Se especifican transportes para evitar bloqueos de websockets en proxies.
        const statusDiv = document.getElementById('status');
        // Para Render o servidores externos, usar polling primero
        const socket = io(window.location.origin, {
            transports: ['polling', 'websocket'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5
        });

        socket.on('connect', () => {
            console.log('✓ Conectado al servidor WebSocket', socket.id);
            statusDiv.textContent = 'Conectado al servidor WebSocket';
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
        });

        socket.on('connect_error', (err) => {
            console.error('connect_error', err);
            statusDiv.textContent = 'Error de conexión: ' + (err && err.message ? err.message : err);
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.color = '#721c24';
        });

        socket.on('reconnect_attempt', () => {
            console.log('Intentando reconectar...');
            statusDiv.textContent = 'Intentando reconectar...';
        });

        socket.on('reconnect', (attempt) => {
            console.log('Reconectado después de', attempt, 'intentos');
            statusDiv.textContent = 'Reconectado';
        });

        socket.on('nuevo_dato', (dato) => {
            console.log('✓ Nuevo dato recibido vía WebSocket:', dato);
            agregarFila(dato);
        });

        function agregarFila(dato) {
            const tbody = document.querySelector('#tabla-datos tbody');
            const nuevaFila = tbody.insertRow(0);
            nuevaFila.className = 'nuevo';

            const tdId = nuevaFila.insertCell(0);
            const tdTemp = nuevaFila.insertCell(1);
            const tdHum = nuevaFila.insertCell(2);
            const tdNode = nuevaFila.insertCell(3);
            const tdFecha = nuevaFila.insertCell(4);

            tdId.textContent = dato.id;
            tdTemp.textContent = parseFloat(dato.temperatura).toFixed(1) + '°C';
            tdHum.textContent = parseFloat(dato.humedad).toFixed(1) + '%';
            tdNode.textContent = dato.nodeId;
            tdFecha.textContent = dato.fecha_creacion;

            // Actualizar contador
            const totalEl = document.getElementById('total');
            const total = parseInt(totalEl.textContent.match(/\d+/)) || 0;
            totalEl.textContent = 'Total de registros: ' + (total + 1);

            // Limitar a 100 filas
            while (tbody.rows.length > 100) {
                tbody.deleteRow(tbody.rows.length - 1);
            }
        }

        // Manejar desconexión
        socket.on('disconnect', (reason) => {
            console.warn('Desconectado:', reason);
            statusDiv.textContent = 'Desconectado: ' + reason;
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
        });
    </script>
</body>
</html>