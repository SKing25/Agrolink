<!DOCTYPE html>
<html lang="es">
<head>
    <title>Datos DHT22 - AgroLink</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', filename='agrolink.png') }}" type="image/x-icon">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <nav class="navbar">
        <a href="{{ url_for('home') }}" class="brand" title="Inicio">
            <img src="{{ url_for('static', filename='agrolink.png') }}" alt="AgroLink" />
            <span>AgroLink</span>
        </a>
        <ul class="nav-links">
            <li><a href="{{ url_for('ver_datos') }}">Tabla General</a></li>
            <li class="dropdown">
                <span>Nodos</span>
                <ul class="submenu">
                    {% for node in nodos %}
                    <li><a href="{{ url_for('ver_por_nodo', node_id=node) }}">{{ node }}</a></li>
                    {% else %}
                    <li><span>Sin nodos</span></li>
                    {% endfor %}
                </ul>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="card">
            <h1>Datos de Todos los Sensores</h1>
            <div id="status" class="status-bar">Conectando al servidor WebSocket...</div>
            <p id="total">Total de registros: {{ datos|length }}</p>

            <table id="tabla-datos">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Temperatura (째C)</th>
                        <th>Humedad (%)</th>
                        <th>Nodo</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dato in datos %}
                    <tr>
                        <td>{{ dato.id }}</td>
                        <td>{{ "%.1f"|format(dato.temperatura) if dato.temperatura is not none else '-' }}째C</td>
                        <td>{{ "%.1f"|format(dato.humedad) if dato.humedad is not none else '-' }}%</td>
                        <td>{{ dato.nodeId or '-' }}</td>
                        <td>{{ dato.fecha_creacion or '-' }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5">No hay datos disponibles</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>
    
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        const statusDiv = document.getElementById('status');
        const socket = io(window.location.origin, { transports: ['polling'] });

        socket.on('connect', () => {
            console.log('Conectado al servidor WebSocket', socket.id);
            statusDiv.textContent = 'Conectado al servidor WebSocket';
            statusDiv.style.background = '#d1e7dd';
            statusDiv.style.color = '#0f5132';
        });

        socket.on('connect_error', (err) => {
            console.error('connect_error', err);
            statusDiv.textContent = 'Error de conexi처n: ' + (err && err.message ? err.message : err);
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.color = '#721c24';
        });

        socket.on('disconnect', (reason) => {
            console.warn('Desconectado:', reason);
            statusDiv.textContent = 'Desconectado: ' + reason;
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
        });

        socket.on('reconnect_attempt', () => {
            statusDiv.textContent = 'Intentando reconectar...';
        });

        socket.on('reconnect', (attempt) => {
            statusDiv.textContent = 'Reconectado';
        });

        socket.on('nuevo_dato', (dato) => {
            console.log('Nuevo dato recibido:', dato);
            agregarFilaDesdeObjeto(dato, true);
        });

        function agregarFilaDesdeObjeto(dato, alFrente=true) {
            const tbody = document.querySelector('#tabla-datos tbody');
            const nuevaFila = alFrente ? tbody.insertRow(0) : tbody.insertRow(-1);
            nuevaFila.className = 'nuevo';

            nuevaFila.insertCell(0).textContent = dato.id ?? '-';
            nuevaFila.insertCell(1).textContent = (dato.temperatura !== undefined && dato.temperatura !== null) ? `${Number(dato.temperatura).toFixed(1)}째C` : '-';
            nuevaFila.insertCell(2).textContent = (dato.humedad !== undefined && dato.humedad !== null) ? `${Number(dato.humedad).toFixed(1)}%` : '-';
            nuevaFila.insertCell(3).textContent = dato.nodeId ?? '-';
            nuevaFila.insertCell(4).textContent = dato.fecha_creacion ?? '-';

            const totalEl = document.getElementById('total');
            const totalText = totalEl.textContent.match(/\d+/);
            const total = totalText ? parseInt(totalText[0]) : 0;
            if (alFrente) {
                totalEl.textContent = 'Total de registros: ' + (total + 1);
            }

            while (tbody.rows.length > 100) {
                tbody.deleteRow(tbody.rows.length - 1);
            }
        }
    </script>
</body>
</html>