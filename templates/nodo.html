<!DOCTYPE html>
<html lang="es" data-theme="">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nodo {{ node_id }} - AgroLink</title>
  <link rel="icon" href="{{ url_for('static', filename='agrolink.png') }}" type="image/x-icon">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
</head>

<body>
  <nav class="navbar">
    <a href="{{ url_for('home') }}" class="brand" title="Inicio">
      <img src="{{ url_for('static', filename='agrolink.png') }}" alt="AgroLink" />
      <span>AgroLink</span>
    </a>
    <ul class="nav-links">
      <li><a href="{{ url_for('ver_datos') }}">Tabla General</a></li>
      <li class="dropdown">
        <span>Nodos</span>
        <ul class="submenu">
          {% for node in nodos %}
          <li><a href="{{ url_for('ver_por_nodo', node_id=node) }}">{{ node }}</a></li>
          {% else %}
          <li><span>Sin nodos</span></li>
          {% endfor %}
        </ul>
      </li>
    </ul>

    <!-- Toggle de tema -->
    <!-- Toggle de tema - Versión simplificada -->
    <div class="theme-toggle">
      <button class="theme-switch" id="themeSwitch" aria-label="Cambiar tema">
        <span class="icon icon-sun" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="4" fill="currentColor" />
            <g stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" opacity="0.95">
              <path d="M12 2v2" />
              <path d="M12 20v2" />
              <path d="M4.22 4.22l1.42 1.42" />
              <path d="M18.36 18.36l1.42 1.42" />
              <path d="M2 12h2" />
              <path d="M20 12h2" />
              <path d="M4.22 19.78l1.42-1.42" />
              <path d="M18.36 5.64l1.42-1.42" />
            </g>
          </svg>
        </span>
        <span class="icon icon-moon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M21 12.79A9 9 0 116.21 3 7 7 0 0021 12.79z" fill="currentColor" />
          </svg>
        </span>
        <span class="knob" aria-hidden="true"></span>
      </button>
    </div>
  </nav>

  <main class="main-content">
    <div class="card">
      <h1>Datos del Nodo: <span class="primary-text">{{ node_id }}</span></h1>
      <div id="status" class="status-bar">Conectando al servidor WebSocket...</div>

      <div class="action-bar">
        <div class="meta-info">
          <p id="total">Total de registros: {{ datos|length }}</p>
        </div>
        <button id="btn-refresh" class="btn">Recargar Datos</button>
      </div>

      <!-- Ubicación del nodo -->
      <div class="status-bar">
        Ubicación actual:
        <strong id="ubicacionNodo">
          {% if ubicacion %}
          {{ 'lat: ' ~ ('%.6f'|format(ubicacion.lat)) ~ ', lon: ' ~ ('%.6f'|format(ubicacion.lon)) }}
          {% else %}
          —
          {% endif %}
        </strong>
      </div>

      <!-- Mapa de ubicaciones de nodos -->
      <div id="leaflet-map"></div>

      <!-- Sección de Gráficas -->
      <div class="charts-container">
        {% if campos.temperatura %}
        <div class="chart-card">
          <h3>Temperatura (°C)</h3>
          <canvas id="chartTemperatura"></canvas>
        </div>
        {% endif %}

        {% if campos.humedad %}
        <div class="chart-card">
          <h3>Humedad (%)</h3>
          <canvas id="chartHumedad"></canvas>
        </div>
        {% endif %}

        {% if campos.soil_moisture %}
        <div class="chart-card">
          <h3>Humedad del Suelo</h3>
          <canvas id="chartSoilMoisture"></canvas>
        </div>
        {% endif %}

        {% if campos.light or campos.percentage %}
        <div class="chart-card">
          <h3>Luz (lux)</h3>
          <canvas id="chartLight"></canvas>
        </div>
        {% endif %}
      </div>

      <table id="tabla-datos">
        <thead>
          <tr>
            <th>ID</th>
            {% if campos.temperatura %}<th>Temp (°C)</th>{% endif %}
            {% if campos.humedad %}<th>Humedad (%)</th>{% endif %}
            {% if campos.soil_moisture %}<th>Hum. Suelo</th>{% endif %}
            {% if campos.light or campos.percentage %}<th>Luz(lux) - (%)</th>{% endif %}
            <th>Timestamp</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          {% for dato in datos %}
          <tr>
            <td>{{ dato.id }}</td>
            {% if campos.temperatura %}<td>{{ "%.1f"|format(dato.temperatura) if dato.temperatura is not none else '-'
              }}</td>{% endif %}
            {% if campos.humedad %}<td>{{ "%.1f"|format(dato.humedad) if dato.humedad is not none else '-' }}</td>{%
            endif %}
            {% if campos.soil_moisture %}<td>{{ "%.0f"|format(dato.soil_moisture) if dato.soil_moisture is not none else
              '-' }}</td>{% endif %}
            {% if campos.light or campos.percentage %}
            <td>
              {% if dato.light is not none and dato.percentage is not none %}
              {{ "%.2f"|format(dato.light) }} - {{ "%.0f"|format(dato.percentage) }}%
              {% elif dato.light is not none %}
              {{ "%.2f"|format(dato.light) }}
              {% elif dato.percentage is not none %}
              {{ "%.0f"|format(dato.percentage) }}%
              {% else %}
              -
              {% endif %}
            </td>
            {% endif %}
            <td>{{ dato.timestamp or '-' }}</td>
            <td>{{ dato.fecha_creacion or '-' }}</td>
          </tr>
          {% else %}
          <tr>
            {% set num_columnas = 3 + (1 if campos.temperatura else 0) + (1 if campos.humedad else 0) + (1 if
            campos.soil_moisture else 0) + (1 if campos.light or campos.percentage else 0) %}
            <td colspan="{{ num_columnas }}">No hay datos disponibles para este nodo</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </main>

  <!-- Tema: script de inicialización (no interfiere con los scripts de abajo) -->
  <script>
    (function () {
    const root = document.documentElement;
    const body = document.body;
    const themeSwitch = document.getElementById('themeSwitch');
    const STORAGE_KEY = 'site-theme';

    function applyTheme(theme) {
        const isDark = theme === 'dark';
        if (isDark) {
            root.setAttribute('data-theme', 'dark');
            body.classList.add('dark-mode');
        } else {
            root.removeAttribute('data-theme');
            body.classList.remove('dark-mode');
        }
    }

    function detectInitialTheme() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved === 'dark' || saved === 'light') return saved;
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark';
        }
        return 'light';
    }

    function toggleTheme() {
        const current = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        applyTheme(next);
        try { 
            localStorage.setItem(STORAGE_KEY, next); 
        } catch (e) {
            console.warn('No se pudo guardar la preferencia del tema:', e);
        }
    }

    // Inicializar tema
    applyTheme(detectInitialTheme());

    // Eventos
    if (themeSwitch) {
        themeSwitch.addEventListener('click', function (e) {
            e.preventDefault();
            toggleTheme();
        });
        
        themeSwitch.addEventListener('keydown', function (e) {
            if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                toggleTheme();
            }
        });
    }

    // Cambios de preferencia del sistema
    if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function (e) {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved !== 'dark' && saved !== 'light') {
                applyTheme(e.matches ? 'dark' : 'light');
            }
        });
    }
})();
  </script>


  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    function safeUpdateChart(chart) { try { if (chart && chart.update) chart.update('none'); } catch (e) { console.warn('No se pudo actualizar chart', e); } }

    function initNodoPage() {
      const mapDiv = document.getElementById('leaflet-map');
      const thisNodeId = {{ node_id|tojson }};
      const ubicacionInicial = {{ ubicacion|tojson }};
      const ubicacionesTodos = {{ ubicaciones_todos|tojson }};
      const centroLat = {{ centro_lat|tojson }};
      const centroLon = {{ centro_lon|tojson }};
      const camposNode = {{ campos|tojson }};
      const initialData = {{ datos_json|tojson }};
      const nodosList = {{ nodos|tojson }};
      console.debug('Init nodo page: centro', centroLat, centroLon);

      // ========== MAPA LEAFLET ==========
      let map = null;
      let layerControl = null;
      const grupos = {}; // nodeId -> layerGroup
      const markersByNode = {}; // nodeId -> L.marker

      // Paleta de colores por nodo (determinística)
      const colorCycle = ['red','blue','green','orange','violet','grey','black','gold'];
      const colorsByNode = {};
      (Array.isArray(nodosList) ? nodosList : []).concat(thisNodeId).forEach((nid, idx) => {
        if (nid && !colorsByNode[nid]) colorsByNode[nid] = colorCycle[idx % colorCycle.length];
      });
      function getColor(nid){ return colorsByNode[nid] || colorCycle[0]; }
      function coloredIcon(color){
        // Usa íconos de colores del proyecto leaflet-color-markers
        const base = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/';
        const file = `marker-icon-${color}.png`;
        return L.icon({
          iconUrl: base + file,
          shadowUrl: base + 'marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });
      }

      try {
        if (window.L) {
          map = L.map('leaflet-map').setView([centroLat || 0, centroLon || 0], 18);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
          setTimeout(() => { try { map.invalidateSize(); } catch(_) {} }, 100);
          layerControl = L.control.layers(null, null, { collapsed: true }).addTo(map);

          function crearGrupoNodo(nid) {
            const lg = L.layerGroup();
            grupos[nid] = lg;
            if (layerControl) layerControl.addOverlay(lg, 'Nodo ' + nid);
            return lg;
          }
          function ensureGrupo(nid){ return grupos[nid] || crearGrupoNodo(nid); }

          // Inicial: crear grupos y marcador para cada nodo con ubicación conocida
          Object.keys(ubicacionesTodos).forEach(nid => {
            const g = ensureGrupo(nid);
            const { lat, lon } = ubicacionesTodos[nid] || {};
            if (lat != null && lon != null) {
              if (!markersByNode[nid]) {
                const m = L.marker([lat, lon], { icon: coloredIcon(getColor(nid)) })
                  .bindPopup('Nodo ' + nid + '<br>lat: ' + Number(lat).toFixed(6) + '<br>lon: ' + Number(lon).toFixed(6));
                m.addTo(g);
                markersByNode[nid] = m;
              } else {
                markersByNode[nid].setLatLng([lat, lon]);
              }
            }
            if (nid === thisNodeId) { g.addTo(map); }
          });

          // Marcador de referencia solo visual (se elimina tras primera actualización del nodo actual)
          let centerMarker = L.circleMarker([centroLat || 0, centroLon || 0], { radius:4, color:'#2563eb', fillColor:'#60a5fa', fillOpacity:0.9 }).addTo(map);

          // Actualizar/crear marcador para un nodo específico
          function actualizarUbicacionNodoGeneric(nid, lat, lon, pan=false){
            if (!map || !window.L) return;
            if (lat == null || lon == null) return;
            const g = ensureGrupo(nid);
            if (markersByNode[nid]) {
              markersByNode[nid].setLatLng([lat, lon]);
            } else {
              const m = L.marker([lat, lon], { icon: coloredIcon(getColor(nid)) })
                .bindPopup('Nodo ' + nid + '<br>lat: ' + Number(lat).toFixed(6) + '<br>lon: ' + Number(lon).toFixed(6));
              m.addTo(g);
              markersByNode[nid] = m;
            }
            if (pan) {
              try { map.panTo([lat, lon]); } catch(_) {}
            }
            if (nid === thisNodeId && centerMarker) { try { map.removeLayer(centerMarker); } catch(_) {} centerMarker = null; }
          }

          // Si tenemos ubicación inicial del nodo actual
          if (ubicacionInicial && ubicacionInicial.lat && ubicacionInicial.lon) {
            actualizarUbicacionNodoGeneric(thisNodeId, ubicacionInicial.lat, ubicacionInicial.lon, true);
          }

          // ========== SOCKET & TABLA / GRÁFICAS ==========
          const socket = io(window.location.origin, { transports: ['polling'] });
          const ubicacionEl = document.getElementById('ubicacionNodo');
          const statusDiv = document.getElementById('status');

          socket.on('connect', () => {
            if (statusDiv) {
              statusDiv.textContent = 'Conectado al servidor WebSocket';
              statusDiv.style.background = '#d1e7dd';
              statusDiv.style.color = '#0f5132';
            }
          });

          // Actualizar cualquier nodo que envíe ubicación
          socket.on('ubicacion_nodo', (data) => {
            if (!data || !data.nodeId) return;
            const nid = String(data.nodeId);
            const lat = Number(data.lat);
            const lon = Number(data.lon);
            const isCurrent = (nid === thisNodeId);
            if (isCurrent && ubicacionEl && !Number.isNaN(lat) && !Number.isNaN(lon)) {
              ubicacionEl.textContent = `lat: ${lat.toFixed(6)}, lon: ${lon.toFixed(6)}`;
            }
            actualizarUbicacionNodoGeneric(nid, lat, lon, isCurrent);
          });

          function clampLen(arr, max=200) { while (arr.length > max) arr.shift(); }
          function pushIfDefined(arr, v) { arr.push((v === undefined || v === null) ? null : Number(v)); }

          // Preparar datos ordenados para gráficas
          const sorted = Array.isArray(initialData) ? [...initialData].sort((a,b) => {
            const ta = a.timestamp || (a.fecha_creacion ? Date.parse(a.fecha_creacion)/1000 : 0);
            const tb = b.timestamp || (b.fecha_creacion ? Date.parse(b.fecha_creacion)/1000 : 0);
            return ta - tb;
          }) : [];
          const labels = sorted.map(d => d.fecha_creacion || (d.timestamp ? new Date(d.timestamp*1000).toISOString() : ''));

          let chartTemperatura, chartHumedad, chartSoil, chartLight;
          try {
            {% if campos.temperatura %}
            const dataTemp = sorted.map(d => d.temperatura!=null ? Number(d.temperatura) : null);
            if (window.Chart) {
              chartTemperatura = new Chart(document.getElementById('chartTemperatura'), { type:'line', data:{ labels:[...labels], datasets:[{ label:'°C', data:dataTemp, borderColor:'#ef4444', tension:0.2, spanGaps:true }] }, options:{ responsive:true, maintainAspectRatio:false } });
            }
            {% endif %}
            {% if campos.humedad %}
            const dataHum = sorted.map(d => d.humedad!=null ? Number(d.humedad) : null);
            if (window.Chart) {
              chartHumedad = new Chart(document.getElementById('chartHumedad'), { type:'line', data:{ labels:[...labels], datasets:[{ label:'%', data:dataHum, borderColor:'#3b82f6', tension:0.2, spanGaps:true }] }, options:{ responsive:true, maintainAspectRatio:false } });
            }
            {% endif %}
            {% if campos.soil_moisture %}
            const dataSoil = sorted.map(d => d.soil_moisture!=null ? Number(d.soil_moisture) : null);
            if (window.Chart) {
              chartSoil = new Chart(document.getElementById('chartSoilMoisture'), { type:'line', data:{ labels:[...labels], datasets:[{ label:'Soil', data:dataSoil, borderColor:'#10b981', tension:0.2, spanGaps:true }] }, options:{ responsive:true, maintainAspectRatio:false } });
            }
            {% endif %}
            {% if campos.light or campos.percentage %}
            const dataLight = sorted.map(d => d.light!=null ? Number(d.light) : null);
            const dataPct = sorted.map(d => d.percentage!=null ? Number(d.percentage) : null);
            if (window.Chart) {
              chartLight = new Chart(document.getElementById('chartLight'), { type:'line', data:{ labels:[...labels], datasets:[{ label:'Luz (lux)', data:dataLight, borderColor:'#f59e0b', tension:0.2, spanGaps:true }, { label:'Luz (%)', data:dataPct, borderColor:'#8b5cf6', tension:0.2, spanGaps:true }] }, options:{ responsive:true, maintainAspectRatio:false } });
            }
            {% endif %}
          } catch (e) {
            console.error('Error creando gráficas:', e);
          }

          socket.on('nuevo_dato', (dato) => {
            if (!dato || dato.nodeId !== thisNodeId) return;
            insertarFila(dato);
            const label = dato.fecha_creacion || (dato.timestamp ? new Date(dato.timestamp*1000).toISOString() : '');
            {% if campos.temperatura %}if (chartTemperatura){ chartTemperatura.data.labels.push(label); clampLen(chartTemperatura.data.labels); pushIfDefined(chartTemperatura.data.datasets[0].data, dato.temperatura); clampLen(chartTemperatura.data.datasets[0].data); safeUpdateChart(chartTemperatura); }{% endif %}
            {% if campos.humedad %}if (chartHumedad){ chartHumedad.data.labels.push(label); clampLen(chartHumedad.data.labels); pushIfDefined(chartHumedad.data.datasets[0].data, dato.humedad); clampLen(chartHumedad.data.datasets[0].data); safeUpdateChart(chartHumedad); }{% endif %}
            {% if campos.soil_moisture %}if (chartSoil){ chartSoil.data.labels.push(label); clampLen(chartSoil.data.labels); pushIfDefined(chartSoil.data.datasets[0].data, dato.soil_moisture); clampLen(chartSoil.data.datasets[0].data); safeUpdateChart(chartSoil); }{% endif %}
            {% if campos.light or campos.percentage %}if (chartLight){ chartLight.data.labels.push(label); clampLen(chartLight.data.labels); pushIfDefined(chartLight.data.datasets[0].data, dato.light); pushIfDefined(chartLight.data.datasets[1].data, dato.percentage); clampLen(chartLight.data.datasets[0].data); clampLen(chartLight.data.datasets[1].data); safeUpdateChart(chartLight); }{% endif %}
          });

          function insertarFila(d) {
            if (!d) return;
            const tbody = document.querySelector('#tabla-datos tbody');
            if (!tbody) return;
            if (d.id !== undefined) {
              for (let i=0;i<tbody.rows.length;i++) {
                if (tbody.rows[i].cells[0] && tbody.rows[i].cells[0].textContent == d.id) return;
              }
            }
            const fila = tbody.insertRow(0); fila.className='nuevo';
            fila.insertCell(-1).textContent = d.id ?? '-';
            if (camposNode.temperatura) fila.insertCell(-1).textContent = d.temperatura!=null ? Number(d.temperatura).toFixed(1) : '-';
            if (camposNode.humedad) fila.insertCell(-1).textContent = d.humedad!=null ? Number(d.humedad).toFixed(1) : '-';
            if (camposNode.soil_moisture) fila.insertCell(-1).textContent = d.soil_moisture!=null ? Number(d.soil_moisture).toFixed(0) : '-';
            if (camposNode.light || camposNode.percentage) {
              let luz='-';
              if (d.light!=null && d.percentage!=null) luz=`${Number(d.light).toFixed(2)} - ${Number(d.percentage).toFixed(0)}%`;
              else if (d.light!=null) luz=Number(d.light).toFixed(2); else if (d.percentage!=null) luz=`${Number(d.percentage).toFixed(0)}%`;
              fila.insertCell(-1).textContent = luz;
            }
            fila.insertCell(-1).textContent = d.timestamp ?? '-';
            fila.insertCell(-1).textContent = d.fecha_creacion ?? '-';
            const totalEl = document.getElementById('total');
            if (totalEl) {
              const m = totalEl.textContent.match(/\d+/);
              const current = m?parseInt(m[0]):0;
              totalEl.textContent = 'Total de registros: ' + (current+1);
            }
            while (tbody.rows.length > 100) tbody.deleteRow(tbody.rows.length-1);
          }
        } else {
          console.error('Leaflet no cargó correctamente');
          if (mapDiv) {
            mapDiv.style.display = 'flex';
            mapDiv.style.alignItems = 'center';
            mapDiv.style.justifyContent = 'center';
            mapDiv.innerText = 'No se pudo cargar el mapa (Leaflet no disponible).';
          }
        }
      } catch (e) {
        console.error('Error inicializando Leaflet:', e);
        if (mapDiv) {
          mapDiv.style.display = 'flex';
          mapDiv.style.alignItems = 'center';
          mapDiv.style.justifyContent = 'center';
          mapDiv.innerText = 'Error al inicializar el mapa.';
        }
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initNodoPage);
    } else {
      initNodoPage();
    }
  </script>
</body>

</html>
