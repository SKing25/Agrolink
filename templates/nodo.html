<!DOCTYPE html>
<html lang="es" data-theme="">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nodo {{ node_id }} - AgroLink</title>
  <link rel="icon" href="{{ url_for('static', filename='agrolink.png') }}" type="image/x-icon">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
  <nav class="navbar">
    <a href="{{ url_for('home') }}" class="brand" title="Inicio">
      <img src="{{ url_for('static', filename='agrolink.png') }}" alt="AgroLink" />
      <span>AgroLink</span>
    </a>
    <ul class="nav-links">
      <li><a href="{{ url_for('ver_datos') }}">Tabla General</a></li>
      <li class="dropdown">
        <span>Nodos</span>
        <ul class="submenu">
          {% for node in nodos %}
          <li><a href="{{ url_for('ver_por_nodo', node_id=node) }}">{{ node }}</a></li>
          {% else %}
          <li><span>Sin nodos</span></li>
          {% endfor %}
        </ul>
      </li>
    </ul>

    <!-- Toggle de tema -->
    <!-- Toggle de tema - Versión simplificada -->
    <div class="theme-toggle">
      <button class="theme-switch" id="themeSwitch" aria-label="Cambiar tema">
        <span class="icon icon-sun" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="4" fill="currentColor" />
            <g stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" opacity="0.95">
              <path d="M12 2v2" />
              <path d="M12 20v2" />
              <path d="M4.22 4.22l1.42 1.42" />
              <path d="M18.36 18.36l1.42 1.42" />
              <path d="M2 12h2" />
              <path d="M20 12h2" />
              <path d="M4.22 19.78l1.42-1.42" />
              <path d="M18.36 5.64l1.42-1.42" />
            </g>
          </svg>
        </span>
        <span class="icon icon-moon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M21 12.79A9 9 0 116.21 3 7 7 0 0021 12.79z" fill="currentColor" />
          </svg>
        </span>
        <span class="knob" aria-hidden="true"></span>
      </button>
    </div>
  </nav>

  <main class="main-content">
    <div class="card">
      <h1>Datos del Nodo: <span class="primary-text">{{ node_id }}</span></h1>
      <div id="status" class="status-bar">Conectando al servidor WebSocket...</div>

      <div class="action-bar">
        <div class="meta-info">
          <p id="total">Total de registros: {{ datos|length }}</p>
        </div>
        <button id="btn-refresh" class="btn">Recargar Datos</button>
      </div>

      <!-- Ubicación del nodo -->
      <div class="status-bar">
        Ubicación actual:
        <strong id="ubicacionNodo">
          {% if ubicacion %}
          {{ 'lat: ' ~ ('%.6f'|format(ubicacion.lat)) ~ ', lon: ' ~ ('%.6f'|format(ubicacion.lon)) }}
          {% else %}
          —
          {% endif %}
        </strong>
      </div>

      <!-- Sección de Gráficas -->
      <div class="charts-container">
        {% if campos.temperatura %}
        <div class="chart-card">
          <h3>Temperatura (°C)</h3>
          <canvas id="chartTemperatura"></canvas>
        </div>
        {% endif %}

        {% if campos.humedad %}
        <div class="chart-card">
          <h3>Humedad (%)</h3>
          <canvas id="chartHumedad"></canvas>
        </div>
        {% endif %}

        {% if campos.soil_moisture %}
        <div class="chart-card">
          <h3>Humedad del Suelo</h3>
          <canvas id="chartSoilMoisture"></canvas>
        </div>
        {% endif %}

        {% if campos.light or campos.light_percentage %}
        <div class="chart-card">
          <h3>Luz (lux)</h3>
          <canvas id="chartLight"></canvas>
        </div>
        {% endif %}
      </div>

      <table id="tabla-datos">
        <thead>
          <tr>
            <th>ID</th>
            {% if campos.temperatura %}<th>Temp (°C)</th>{% endif %}
            {% if campos.humedad %}<th>Humedad (%)</th>{% endif %}
            {% if campos.soil_moisture %}<th>Hum. Suelo</th>{% endif %}
            {% if campos.light or campos.light_percentage %}<th>Luz(lux) - (%)</th>{% endif %}
            <th>Timestamp</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          {% for dato in datos %}
          <tr>
            <td>{{ dato.id }}</td>
            {% if campos.temperatura %}<td>{{ "%.1f"|format(dato.temperatura) if dato.temperatura is not none else '-'
              }}</td>{% endif %}
            {% if campos.humedad %}<td>{{ "%.1f"|format(dato.humedad) if dato.humedad is not none else '-' }}</td>{%
            endif %}
            {% if campos.soil_moisture %}<td>{{ "%.0f"|format(dato.soil_moisture) if dato.soil_moisture is not none else
              '-' }}</td>{% endif %}
            {% if campos.light or campos.light_percentage %}
            <td>
              {% if dato.light is not none and dato.percentage is not none %}
              {{ "%.2f"|format(dato.light) }} - {{ "%.0f"|format(dato.percentage) }}%
              {% elif dato.light is not none %}
              {{ "%.2f"|format(dato.light) }}
              {% elif dato.percentage is not none %}
              {{ "%.0f"|format(dato.percentage) }}%
              {% else %}
              -
              {% endif %}
            </td>
            {% endif %}
            <td>{{ dato.timestamp or '-' }}</td>
            <td>{{ dato.fecha_creacion or '-' }}</td>
          </tr>
          {% else %}
          <tr>
            {% set num_columnas = 3 + (1 if campos.temperatura else 0) + (1 if campos.humedad else 0) + (1 if
            campos.soil_moisture else 0) + (1 if campos.light or campos.light_percentage else 0) %}
            <td colspan="{{ num_columnas }}">No hay datos disponibles para este nodo</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </main>

  <!-- Tema: script de inicialización (no interfiere con los scripts de abajo) -->
  <script>
    (function () {
    const root = document.documentElement;
    const body = document.body;
    const themeSwitch = document.getElementById('themeSwitch');
    const STORAGE_KEY = 'site-theme';

    function applyTheme(theme) {
        const isDark = theme === 'dark';
        if (isDark) {
            root.setAttribute('data-theme', 'dark');
            body.classList.add('dark-mode');
        } else {
            root.removeAttribute('data-theme');
            body.classList.remove('dark-mode');
        }
    }

    function detectInitialTheme() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved === 'dark' || saved === 'light') return saved;
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark';
        }
        return 'light';
    }

    function toggleTheme() {
        const current = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        applyTheme(next);
        try { 
            localStorage.setItem(STORAGE_KEY, next); 
        } catch (e) {
            console.warn('No se pudo guardar la preferencia del tema:', e);
        }
    }

    // Inicializar tema
    applyTheme(detectInitialTheme());

    // Eventos
    if (themeSwitch) {
        themeSwitch.addEventListener('click', function (e) {
            e.preventDefault();
            toggleTheme();
        });
        
        themeSwitch.addEventListener('keydown', function (e) {
            if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                toggleTheme();
            }
        });
    }

    // Cambios de preferencia del sistema
    if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function (e) {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved !== 'dark' && saved !== 'light') {
                applyTheme(e.matches ? 'dark' : 'light');
            }
        });
    }
})();
  </script>


  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
  const socket = io(window.location.origin, { transports: ['polling'] });
  const ubicacionEl = document.getElementById('ubicacionNodo');
  const thisNodeId = {{ node_id|tojson }};
  const initialData = {{ datos_json|tojson }};
  const camposNode = {{ campos|tojson }}; // Exponer qué columnas se muestran

  // Preparar datos en orden cronológico (ascendente)
  const sorted = [...initialData].sort((a, b) => {
    const ta = a.timestamp || (a.fecha_creacion ? Date.parse(a.fecha_creacion) / 1000 : 0);
    const tb = b.timestamp || (b.fecha_creacion ? Date.parse(b.fecha_creacion) / 1000 : 0);
    return ta - tb;
  });
  const labels = sorted.map(d => d.fecha_creacion || (d.timestamp ? new Date(d.timestamp * 1000).toISOString() : ''));

  // Utilidades
  function clampLen(arr, max=200) { while (arr.length > max) arr.shift(); }
  function pushIfDefined(arr, v) { arr.push((v === undefined || v === null) ? null : Number(v)); }

  // Función para insertar una fila nueva al inicio de la tabla
  function insertarFila(d) {
    if (!d) return;
    const tbody = document.querySelector('#tabla-datos tbody');
    if (!tbody) return;
    // Evitar duplicados si ya existe el ID
    if (d.id !== undefined) {
      for (let i=0; i<tbody.rows.length; i++) {
        const cell = tbody.rows[i].cells[0];
        if (cell && cell.textContent == d.id) {
          return; // ya existe
        }
      }
    }
    const fila = tbody.insertRow(0);
    fila.className = 'nuevo';
    // Orden de columnas igual que en el <thead>
    // ID
    fila.insertCell(-1).textContent = d.id ?? '-';
    // Temperatura
    if (camposNode.temperatura) {
      const tCell = fila.insertCell(-1);
      if (d.temperatura !== undefined && d.temperatura !== null) {
        const t = Number(d.temperatura); tCell.textContent = isNaN(t) ? '-' : t.toFixed(1);
      } else { tCell.textContent = '-'; }
    }
    // Humedad
    if (camposNode.humedad) {
      const hCell = fila.insertCell(-1);
      if (d.humedad !== undefined && d.humedad !== null) {
        const h = Number(d.humedad); hCell.textContent = isNaN(h) ? '-' : h.toFixed(1);
      } else { hCell.textContent = '-'; }
    }
    // Humedad suelo
    if (camposNode.soil_moisture) {
      const sCell = fila.insertCell(-1);
      if (d.soil_moisture !== undefined && d.soil_moisture !== null) {
        const s = Number(d.soil_moisture); sCell.textContent = isNaN(s) ? '-' : s.toFixed(0);
      } else { sCell.textContent = '-'; }
    }
    // Luz (lux - %)
    const mostrarLuz = camposNode.light || camposNode.percentage;
    if (mostrarLuz) {
      const lCell = fila.insertCell(-1);
      let luzTexto = '-';
      const hasLight = d.light !== undefined && d.light !== null;
      const hasPct = d.percentage !== undefined && d.percentage !== null;
      if (hasLight && hasPct) {
        luzTexto = `${Number(d.light).toFixed(2)} - ${Number(d.percentage).toFixed(0)}%`;
      } else if (hasLight) {
        luzTexto = `${Number(d.light).toFixed(2)}`;
      } else if (hasPct) {
        luzTexto = `${Number(d.percentage).toFixed(0)}%`;
      }
      lCell.textContent = luzTexto;
    }
    // Timestamp
    fila.insertCell(-1).textContent = (d.timestamp !== undefined && d.timestamp !== null) ? d.timestamp : '-';
    // Fecha
    fila.insertCell(-1).textContent = d.fecha_creacion ?? '-';

    // Actualizar contador
    const totalEl = document.getElementById('total');
    if (totalEl) {
      const match = totalEl.textContent.match(/\d+/);
      const current = match ? parseInt(match[0]) : 0;
      totalEl.textContent = 'Total de registros: ' + (current + 1);
    }

    // Limitar filas
    while (tbody.rows.length > 100) tbody.deleteRow(tbody.rows.length - 1);
  }

  // Gráficas
  let chartTemperatura, chartHumedad, chartSoil, chartLight;
  {% if campos.temperatura %}
  const dataTemp = sorted.map(d => d.temperatura !== undefined && d.temperatura !== null ? Number(d.temperatura) : null);
  chartTemperatura = new Chart(document.getElementById('chartTemperatura'), {
    type: 'line', data: { labels: [...labels], datasets: [{ label: '°C', data: dataTemp, borderColor: '#ef4444', tension: 0.2, spanGaps: true }] },
    options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { maxRotation: 0 } }, y: { title: { display: true, text: '°C' } } } }
  });
  {% endif %}

  {% if campos.humedad %}
  const dataHum = sorted.map(d => d.humedad !== undefined && d.humedad !== null ? Number(d.humedad) : null);
  chartHumedad = new Chart(document.getElementById('chartHumedad'), {
    type: 'line', data: { labels: [...labels], datasets: [{ label: '%', data: dataHum, borderColor: '#3b82f6', tension: 0.2, spanGaps: true }] },
    options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { maxRotation: 0 } }, y: { title: { display: true, text: '%' }, suggestedMin: 0, suggestedMax: 100 } } }
  });
  {% endif %}

  {% if campos.soil_moisture %}
  const dataSoil = sorted.map(d => d.soil_moisture !== undefined && d.soil_moisture !== null ? Number(d.soil_moisture) : null);
  chartSoil = new Chart(document.getElementById('chartSoilMoisture'), {
    type: 'line', data: { labels: [...labels], datasets: [{ label: 'Soil', data: dataSoil, borderColor: '#10b981', tension: 0.2, spanGaps: true }] },
    options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { maxRotation: 0 } } } }
  });
  {% endif %}

  {% if campos.light or campos.light_percentage %}
  const dataLight = sorted.map(d => d.light !== undefined && d.light !== null ? Number(d.light) : null);
  const dataPct = sorted.map(d => d.percentage !== undefined && d.percentage !== null ? Number(d.percentage) : null);
  chartLight = new Chart(document.getElementById('chartLight'), {
    type: 'line',
    data: { labels: [...labels], datasets: [
      { label: 'Luz (lux)', data: dataLight, borderColor: '#f59e0b', tension: 0.2, spanGaps: true, yAxisID: 'y' },
      { label: 'Luz (%)', data: dataPct, borderColor: '#8b5cf6', tension: 0.2, spanGaps: true, yAxisID: 'y1' }
    ]},
    options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { maxRotation: 0 } }, y: { position: 'left', title: { display: true, text: 'lux' } }, y1: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: '%' }, suggestedMin: 0, suggestedMax: 100 } } }
  });
  {% endif %}

  // Actualizar ubicación en tiempo real
  socket.on('ubicacion_nodo', (data) => {
    if (!data || data.nodeId !== thisNodeId) return;
    if (ubicacionEl) {
      const lat = (data.lat !== undefined && data.lat !== null) ? Number(data.lat).toFixed(6) : '—';
      const lon = (data.lon !== undefined && data.lon !== null) ? Number(data.lon).toFixed(6) : '—';
      ubicacionEl.textContent = `lat: ${lat}, lon: ${lon}`;
    }
  });

  // Actualizar gráficas y tabla en tiempo real
  socket.on('nuevo_dato', (dato) => {
    if (!dato || dato.nodeId !== thisNodeId) return;
    const label = dato.fecha_creacion || (dato.timestamp ? new Date(dato.timestamp * 1000).toISOString() : '');
    // Gráficas
    {% if campos.temperatura %}
    if (chartTemperatura) {
      chartTemperatura.data.labels.push(label); clampLen(chartTemperatura.data.labels);
      pushIfDefined(chartTemperatura.data.datasets[0].data, dato.temperatura); clampLen(chartTemperatura.data.datasets[0].data);
      chartTemperatura.update('none');
    }
    {% endif %}

    {% if campos.humedad %}
    if (chartHumedad) {
      chartHumedad.data.labels.push(label); clampLen(chartHumedad.data.labels);
      pushIfDefined(chartHumedad.data.datasets[0].data, dato.humedad); clampLen(chartHumedad.data.datasets[0].data);
      chartHumedad.update('none');
    }
    {% endif %}

    {% if campos.soil_moisture %}
    if (chartSoil) {
      chartSoil.data.labels.push(label); clampLen(chartSoil.data.labels);
      pushIfDefined(chartSoil.data.datasets[0].data, dato.soil_moisture); clampLen(chartSoil.data.datasets[0].data);
      chartSoil.update('none');
    }
    {% endif %}

    {% if campos.light or campos.light_percentage %}
    if (chartLight) {
      chartLight.data.labels.push(label); clampLen(chartLight.data.labels);
      pushIfDefined(chartLight.data.datasets[0].data, dato.light); clampLen(chartLight.data.datasets[0].data);
      pushIfDefined(chartLight.data.datasets[1].data, dato.percentage); clampLen(chartLight.data.datasets[1].data);
      chartLight.update('none');
    }
    {% endif %}
    // Tabla
    insertarFila(dato);
  });
  </script>
</body>

</html>

