<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nodo {{ node_id }} - AgroLink</title>
    <link rel="icon" href="{{ url_for('static', filename='agrolink.png') }}" type="image/x-icon">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <nav class="navbar">
        <a href="{{ url_for('home') }}" class="brand" title="Inicio">
            <img src="{{ url_for('static', filename='agrolink.png') }}" alt="AgroLink" />
            <span>AgroLink</span>
        </a>
        <ul class="nav-links">
            <li><a href="{{ url_for('ver_datos') }}">Tabla</a></li>
            <li class="dropdown">
                <span>Nodos</span>
                <ul class="submenu">
                    {% for node in nodos %}
                    <li><a href="{{ url_for('ver_por_nodo', node_id=node) }}">{{ node }}</a></li>
                    {% else %}
                    <li><span>Sin nodos</span></li>
                    {% endfor %}
                </ul>
            </li>
        </ul>
    </nav>

    <div class="container">
        <h1>Datos del Nodo: <span style="color: #4CAF50;">{{ node_id }}</span></h1>
        <div id="status" style="margin-bottom:10px;padding:8px;border-radius:4px;background:#f8f9fa;color:#333">Conectando al servidor WebSocket...</div>

        <div style="margin-bottom: 16px;">
            <p id="total">Total de registros: {{ datos|length }}</p>
            <button id="btn-refresh" style="padding:8px 16px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer;">
                Recargar últimos 100
            </button>
        </div>

        <table id="tabla-datos">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Temperatura (°C)</th>
                    <th>Humedad (%)</th>
                    <th>Timestamp</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody>
                {% for dato in datos %}
                <tr>
                    <td>{{ dato.id }}</td>
                    <td class="temp">
                        {% if dato.temperatura is not none %}
                            {{ "%.1f"|format(dato.temperatura) }}°C
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="hum">
                        {% if dato.humedad is not none %}
                            {{ "%.1f"|format(dato.humedad) }}%
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ dato.timestamp or '-' }}</td>
                    <td>{{ dato.fecha_creacion or '-' }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5">No hay datos disponibles para este nodo</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Socket.IO client -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        const NODE_ID = "{{ node_id }}";
        const statusDiv = document.getElementById('status');
        const totalEl = document.getElementById('total');
        const btnRefresh = document.getElementById('btn-refresh');
        const tbody = document.querySelector('#tabla-datos tbody');

        // Conectar con polling para evitar errores en servidor de desarrollo
        const socket = io(window.location.origin, { transports: ['polling'] });

        socket.on('connect', () => {
            console.log('Conectado al servidor WebSocket', socket.id);
            statusDiv.textContent = 'Conectado - Escuchando datos del nodo ' + NODE_ID;
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
        });

        socket.on('connect_error', (err) => {
            console.error('connect_error', err);
            statusDiv.textContent = 'Error de conexión: ' + (err && err.message ? err.message : err);
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.color = '#721c24';
        });

        socket.on('disconnect', (reason) => {
            console.warn('Desconectado:', reason);
            statusDiv.textContent = 'Desconectado: ' + reason;
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
        });

        // Nuevo dato en tiempo real - filtrar por nodeId
        socket.on('nuevo_dato', (dato) => {
            console.log('Nuevo dato recibido:', dato);

            // Solo mostrar si corresponde a este nodo
            if (dato && dato.nodeId && String(dato.nodeId) === String(NODE_ID)) {
                agregarFila(dato);
            }
        });

        // Respuesta al solicitar datos históricos
        socket.on('resultado_datos', (payload) => {
            console.log('Datos históricos recibidos:', payload);
            if (payload && payload.datos && Array.isArray(payload.datos)) {
                tbody.innerHTML = '';
                payload.datos.forEach(d => agregarFilaDesdeObjeto(d, false));
                totalEl.textContent = 'Total de registros: ' + tbody.children.length;
                statusDiv.textContent = 'Datos actualizados';
            }
        });

        function agregarFila(dato) {
            agregarFilaDesdeObjeto(dato, true);
        }

        function agregarFilaDesdeObjeto(dato, alFrente = true) {
            const nuevaFila = alFrente ? tbody.insertRow(0) : tbody.insertRow(-1);
            nuevaFila.className = 'nuevo';

            const tdId = nuevaFila.insertCell(0);
            const tdTemp = nuevaFila.insertCell(1);
            const tdHum = nuevaFila.insertCell(2);
            const tdTimestamp = nuevaFila.insertCell(3);
            const tdFecha = nuevaFila.insertCell(4);

            tdId.textContent = dato.id ?? '-';

            // Temperatura
            if (dato.temperatura !== undefined && dato.temperatura !== null) {
                const t = Number(dato.temperatura);
                tdTemp.textContent = isNaN(t) ? '-' : t.toFixed(1) + '°C';
                tdTemp.className = 'temp';
            } else {
                tdTemp.textContent = '-';
            }

            // Humedad
            if (dato.humedad !== undefined && dato.humedad !== null) {
                const h = Number(dato.humedad);
                tdHum.textContent = isNaN(h) ? '-' : h.toFixed(1) + '%';
                tdHum.className = 'hum';
            } else {
                tdHum.textContent = '-';
            }

            tdTimestamp.textContent = dato.timestamp ?? '-';
            tdFecha.textContent = dato.fecha_creacion ?? '-';

            // Actualizar contador si se añade al frente
            if (alFrente) {
                const total = parseInt(totalEl.textContent.match(/\d+/)) || 0;
                totalEl.textContent = 'Total de registros: ' + (total + 1);
            }

            // Limitar a 100 filas en DOM
            while (tbody.rows.length > 100) {
                tbody.deleteRow(tbody.rows.length - 1);
            }
        }

        // Botón para recargar datos
        btnRefresh.addEventListener('click', () => {
            statusDiv.textContent = 'Solicitando datos...';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
            socket.emit('solicitar_datos', { limit: 100, offset: 0, nodeId: NODE_ID });
        });

        socket.on('error', (e) => {
            console.error('Socket error:', e);
            statusDiv.textContent = 'Error: ' + (e.mensaje || JSON.stringify(e));
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.color = '#721c24';
        });
    </script>
</body>
</html>

