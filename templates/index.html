<!DOCTYPE html>
<html lang="es" data-theme="">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AgroLink</title>
    <link rel="icon" href="{{ url_for('static', filename='agrolink.png') }}" type="image/x-icon">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
</head>

<body>
    <nav class="navbar">
        <a href="{{ url_for('home') }}" class="brand" title="Inicio">
            <img src="{{ url_for('static', filename='agrolink.png') }}" alt="AgroLink" />
            <span>AgroLink</span>
        </a>
        <ul class="nav-links">
            <li><a href="{{ url_for('ver_datos') }}">Tabla General</a></li>
            <li class="dropdown">
                <span>Nodos</span>
                <ul class="submenu">
                    {% for node in nodos %}
                    <li><a href="{{ url_for('ver_por_nodo', node_id=node) }}">{{ node }}</a></li>
                    {% else %}
                    <li><span>Sin nodos</span></li>
                    {% endfor %}
                </ul>
            </li>
        </ul>
        <div class="theme-toggle">
            <button class="theme-switch" id="themeSwitch" aria-label="Cambiar tema">
                <span class="icon icon-sun" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="4" fill="currentColor" />
                        <g stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" opacity="0.95">
                            <path d="M12 2v2" /><path d="M12 20v2" /><path d="M4.22 4.22l1.42 1.42" /><path d="M18.36 18.36l1.42 1.42" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="M4.22 19.78l1.42-1.42" /><path d="M18.36 5.64l1.42-1.42" />
                        </g>
                    </svg>
                </span>
                <span class="icon icon-moon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none">
                        <path d="M21 12.79A9 9 0 116.21 3 7 7 0 0021 12.79z" fill="currentColor" />
                    </svg>
                </span>
                <span class="knob" aria-hidden="true"></span>
            </button>
        </div>
    </nav>

    <main class="main-content">
      <div class="card">
        <h1>Panel General</h1>
        <div class="flex-row">
          <div class="status-bar" id="gatewayStatus">Gateway IP: <strong id="gatewayIP">{{ gateway_ip or '—' }}</strong></div>
        </div>

        <!-- Tarjetas de métricas -->
        <div class="dashboard-grid" id="metricsGrid">
          <div class="metric-card" id="metricRegistros">
            <h3>Registros</h3>
            <div class="value">{{ total_registros or 0 }}</div>
            <div class="sub">Total acumulado</div>
          </div>
          <div class="metric-card" id="metricNodos">
            <h3>Nodos Activos</h3>
            <div class="value">{{ nodos|length }}</div>
            <div class="sub">Detectados</div>
          </div>
          <div class="metric-card" id="metricUltimo">
            <h3>Último Dato</h3>
            <div class="value time-local" {% if ultimo_dato and ultimo_dato.fecha_creacion %}{% set fc = ultimo_dato.fecha_creacion %}{% if fc.strftime is defined %}data-ts="{{ fc.strftime('%Y-%m-%dT%H:%M:%S') }}"{% else %}data-ts="{{ fc }}"{% endif %}{% endif %}>—</div>
            <div class="sub">Hora local</div>
          </div>
        </div>

        <!-- Últimos datos (vista rápida) -->
        <h2 class="section-title">Últimos Datos</h2>
        <table id="ultimos-datos-table">
          <thead>
            <tr><th>ID</th><th>Nodo</th><th>Temp(°C)</th><th>Hum(%)</th><th>Luz</th><th>Hora</th></tr>
          </thead>
          <tbody id="ultimosTbody">
            {% if ultimo_dato %}
              <tr>
                <td>{{ ultimo_dato.id }}</td>
                <td>{{ ultimo_dato.nodeId or '-' }}</td>
                <td>{% if ultimo_dato.temperatura is not none %}{{ '%.1f'|format(ultimo_dato.temperatura) }}{% else %}-{% endif %}</td>
                <td>{% if ultimo_dato.humedad is not none %}{{ '%.1f'|format(ultimo_dato.humedad) }}{% else %}-{% endif %}</td>
                <td>{% if ultimo_dato.light is not none and ultimo_dato.percentage is not none %}{{ '%.2f'|format(ultimo_dato.light) }} - {{ '%.0f'|format(ultimo_dato.percentage) }}%{% elif ultimo_dato.light is not none %}{{ '%.2f'|format(ultimo_dato.light) }}{% elif ultimo_dato.percentage is not none %}{{ '%.0f'|format(ultimo_dato.percentage) }}%{% else %}-{% endif %}</td>
                <td class="time-local" {% if ultimo_dato and ultimo_dato.fecha_creacion %}{% set fc = ultimo_dato.fecha_creacion %}{% if fc.strftime is defined %}data-ts="{{ fc.strftime('%Y-%m-%dT%H:%M:%S') }}"{% else %}data-ts="{{ fc }}"{% endif %}{% endif %}>—</td>
              </tr>
            {% else %}
              <tr><td colspan="6">No hay datos aún</td></tr>
            {% endif %}
          </tbody>
        </table>

        <!-- Mini gráficas (placeholders) -->
        <h2 class="section-title">Resumen Rápido</h2>
        <div class="mini-charts" id="miniCharts">
          <div class="mini-chart" id="chartTempAvg"><h4>Temp Prom (acumulado)</h4><div class="avg-value" id="avgTemp">—</div><canvas id="sparkTemp"></canvas></div>
          <div class="mini-chart" id="chartHumAvg"><h4>Hum Prom (acumulado)</h4><div class="avg-value" id="avgHum">—</div><canvas id="sparkHum"></canvas></div>
          <div class="mini-chart" id="chartLightAvg"><h4>Luz Prom (acumulado)</h4><div class="avg-value" id="avgLight">—</div><canvas id="sparkLight"></canvas></div>
          <div class="mini-chart" id="chartSueloAvg"><h4>Suelo Prom (acumulado)</h4><div class="avg-value" id="avgSoil">—</div><canvas id="sparkSoil"></canvas></div>
        </div>

        <!-- Mapa (si se decide mostrar en index más adelante) -->
        <h2 class="section-title">Mapa de Nodos</h2>
        <div class="map-container" style="height:420px">
          <div id="index-map" style="width:100%; height:100%"></div>
        </div>

      </div>
    </main>

    <script>window.PAGE_DATA = {
      gateway_ip: {{ gateway_ip|default(None)|tojson }},
      total_registros: {{ total_registros|default(0)|tojson }},
      nodos: {{ nodos|default([])|tojson }},
      ubicacionesTodos: {{ ubicaciones_todos|default({})|tojson }},
      centroLat: {{ centro_lat|default(0)|tojson }},
      centroLon: {{ centro_lon|default(0)|tojson }}
    };</script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script src="{{ url_for('static', filename='js/index.js') }}"></script>
</body>

</html>

